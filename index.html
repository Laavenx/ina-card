
<!-- 4649 <3 -->

<meta charset=utf-8 />
<title>Ninomae Ina'nis End Card</title>

<!-- tako favicon -->
<link rel=icon type=image/gif href=takoflap.gif />

<meta name=viewport content=width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0 />

<meta property=og:description content="Ina's end card; forever" />
<meta property=og:image content="https://pbs.twimg.com/media/Ehw3YGDUwAEnhlX?format=jpg&name=orig" />


<!--ex> d <-->
<link rel=stylesheet href=card.css />
<!--ex> a
<style>$css</style>
.
s#$css#\=system('cat card.css')#
%s#panel.png#data:image/png;base64,$panel#
%s#$panel#\=system('base64 -i panel.png | tr -d "\n"')#
<-->



<body class=noscript>
    <script>document.body.className = ''</script>
    
    <div class=panel id=left></div>
    <div class=panel id=right></div>
    
    <!--ex> d <-->
    <img id=tako src=takoflap.gif />
    <!--ex> a
    <img id=tako src="data:image/gif;base64,$image" />
.
    | s/$image/\=system('base64 -i takoflap.gif | tr -d "\n"')/
    <-->
    
    
    <div id=background></div>
    <div id=rain></div>
    
    <div id=footer>
        <p>Code <span id=yoroshiku>Braincell #4649</span></p> <!-- Indy#4649 -->
        <p>Loop <span id=illusion>Braincell #1253 | Illusion</span></p>
        <p>Art &amp; bgm <a target=_blank href=https://twitter.com/ninomaeinanis/status/1304979032149078016>Ninomae Ina'nis</a></p>
        
        <noscript>
            <audio id=loop autoplay loop controls preload=auto>
                <source src=bg-loop.m4a?embed type=audio/mp4>
                <source src=bg-loop.mp3?embed type=audio/mpeg>
                <source src=bg-loop.ogg?embed type=audio/ogg>
            </audio>
        </noscript>
    </p>
    
    <script>
        
        /* Loading indicator */
        var tako = document.getElementById('tako')
        /* Force click to play media */
        var panels = Array.from(document.getElementsByClassName('panel'))
        
        /* Audio ready to play, get click */
        var playing = false
        function readyToPlay(callback) {
            
            tako.style.opacity = '0'
            tako.style.visibility = 'hidden'
            
            // todo: detect autoplay
            panels.concat(tako).forEach(l => {
                l.style.cursor = 'pointer'
                l.addEventListener('click', function() {
                    panels.forEach(p => p.classList.add('running'))
                    // idempotency
                    if(!playing) callback()
                    playing = true
                })
            })
            
        }
        
        /* Audio element method (fallback) **/
        var audio
        var fallenBack = false
        function fallback() {
            if (fallenBack) console.error("Already fell ;-;")
            fallenBack = true
            
            console.log("Falling back to HTML5 <audio>")
            document.getElementById('footer').insertAdjacentHTML(
                'beforeend',
                document.getElementsByTagName('noscript')[0].innerText
            )
            
            audio = document.getElementById('loop')
            audio.addEventListener('loadeddata', function() {
                readyToPlay(function() {
                    console.log("Playing using <audio> fallback")
                    audio.play()
                })
            })
            // TODO: gapless-ish by using two audio elements
        }
        
        /* WebAudio (intro + gapless) */
        // TODO: determine encoding
        var introSrc = 'bg-intro.m4a?webaudio'
        var loopSrc = 'bg-loop.m4a?webaudio'
        
        // Safari polyfill
        /* https://gist.github.com/jakearchibald/131d7101b134b6f7bed1d8320e4da599 */
        if (!window.AudioContext && window.webkitAudioContext) {
            const oldFunc = webkitAudioContext.prototype.decodeAudioData
            webkitAudioContext.prototype.decodeAudioData = function(arraybuffer) {
                return new Promise((resolve, reject) => {
                    oldFunc.call(this, arraybuffer, resolve, reject)
                })
            }
        }
        
        // Detect Chrome (requires user input before creating the audio context)
        
        
        // All of this is just for gapless playback
        var AudioContext = window.AudioContext || window.webkitAudioContext
        try { var context = new AudioContext() }
        catch(e) {
            console.error(e)
            fallback()
        }
        
        var introSource
        var loopSource
        if (context) {
            
            // Using promises as callbacks for simplicity
            // https://caniuse.com/?search=await
            
            fetch(introSrc)
            .then(response => response.arrayBuffer())
            .then(buffer => context.decodeAudioData(buffer))
            .catch(e => {
                console.error(e)
                fallback()
            })
            .then(introBuffer => {
                 if (!introBuffer) return
                 
                 introSource = context.createBufferSource()
                 introSource.buffer = introBuffer
                 introSource.connect(context.destination)
                 
                 readyToPlay(function() {
                     console.log("Playing using WebAudio API")
                     introSource.start()
                 })
                 
                 fetch(loopSrc)
                 .then(response => response.arrayBuffer())
                 .then(buffer => context.decodeAudioData(buffer))
                 .catch(e => {
                     console.error(e)
                     // todo: test this path
                     console.log('Oh no, failed to load loop')
                     introSource.loop = true
                 })
                 .then(loopBuffer => {
                     if (!loopBuffer) return
                     loopSource = context.createBufferSource()
                     loopSource.buffer = loopBuffer
                     loopSource.connect(context.destination)
                     loopSource.loop = true
                     loopSource.start(introBuffer.duration)
                 })
                
            })
            
        }
    </script>
    
</body>

<!-- Made with love <3 -->
<!-- Come join the Ina'nis fan discord~ https://discord.gg/tentacult -->

<!-- todo: <audio> <audio> hot swapping for better gap with fallback -->

